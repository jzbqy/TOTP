<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { width: 300px; padding: 16px; font-family: Arial, sans-serif; }
    button { width: 100%; padding: 8px; margin: 4px 0; border: 1px solid #ccc; background: #f5f5f5; border-radius: 4px; cursor: pointer; }
    button:hover { background: #e5e5e5; }
    .add-site { background: #007cba; color: white; border-color: #007cba; }
  </style>
</head>
<body>
  <h3>TOTP验证码助手</h3>
  <div id="sites"></div>
  <button class="add-site" id="add-btn">添加站点</button>
  <button id="manage-btn">管理站点</button>
  
  <script>
    console.log('Popup script loaded');
    
    document.getElementById('add-btn').addEventListener('click', function() {
      console.log('Add button clicked');
      alert('添加按钮被点击了！');
    });
    
    document.getElementById('manage-btn').addEventListener('click', function() {
      console.log('Manage button clicked');
      const url = chrome.runtime.getURL('options.html');
      chrome.tabs.create({ url: url });
    });
    
    // 加载站点
    chrome.storage.sync.get(['totpSites'], function(result) {
      const sites = result.totpSites || {};
      const container = document.getElementById('sites');
      
      if (Object.keys(sites).length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center;">暂无站点配置</p>';
        return;
      }
      
      for (const [name, data] of Object.entries(sites)) {
        const div = document.createElement('div');
        div.style.cssText = 'border: 1px solid #ddd; padding: 8px; margin: 4px 0; border-radius: 4px;';
        div.innerHTML = `
          <div style="font-weight: bold;">${name}</div>
          <div style="font-family: monospace; font-size: 18px; margin: 4px 0;" id="code-${name}">------</div>
          <button onclick="copyCode('${name}')" style="width: 100%; padding: 4px;">复制</button>
        `;
        container.appendChild(div);
      }
      
      // 更新验证码
      updateCodes();
      setInterval(updateCodes, 1000);
    });
    
    function updateCodes() {
      chrome.storage.sync.get(['totpSites'], function(result) {
        const sites = result.totpSites || {};
        for (const [name, data] of Object.entries(sites)) {
          const element = document.getElementById('code-' + name);
          if (element && data.secret) {
            try {
              const code = generateTOTP(data.secret);
              element.textContent = code;
            } catch (e) {
              element.textContent = '错误';
            }
          }
        }
      });
    }
    
    function copyCode(siteName) {
      chrome.storage.sync.get(['totpSites'], function(result) {
        const sites = result.totpSites || {};
        const siteData = sites[siteName];
        if (siteData && siteData.secret) {
          const code = generateTOTP(siteData.secret);
          const textarea = document.createElement('textarea');
          textarea.value = code;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          alert('验证码已复制: ' + code);
        }
      });
    }
    
    // 简化的TOTP生成
    function generateTOTP(secret) {
      return '123456'; // 临时返回固定值测试
    }
  </script>
</body>
</html>